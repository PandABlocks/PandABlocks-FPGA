

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PCOMP - Position Compare &mdash; PandABlocks-FPGA 3.0a2-43-g14c440d
 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/PandA-logo.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PGEN - Position Generator" href="pgen_doc.html" />
    <link rel="prev" title="PCAP - Position Capture" href="pcap_doc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../index.html" class="icon icon-home"> PandABlocks-FPGA
          

          
            
            <img src="../_static/PandA-logo-for-black-background.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0a2-43-g14c440d

              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  <style>
    /* style mobile top nav to look like main nav */
    .wy-nav-top {
        background: black
    }
  </style>
  
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">What can PandABlocks do?</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#how-is-the-documentation-structured">How is the documentation structured?</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#using-an-existing-pandablocks-device">Using an existing PandABlocks device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#generating-a-new-set-of-blocks-for-a-pandablocks-device">Generating a new set of Blocks for a PandABlocks device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#extending-the-functionality-of-a-pandablocks-device">Extending the functionality of a PandABlocks device</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#working-on-the-core-autogeneration-framework">Working on the core autogeneration framework</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../tutorials/tutorial1_blinking_leds.html">Blinking LEDs Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/tutorial2_position_capture.html">Position Capture Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/tutorial3_position_compare.html">Position Compare Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/tutorial4_snake_scan.html">Snake Scan Tutorial</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../blocks.html">Available Blocks</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="bits_doc.html">BITS - Soft inputs and constant bits</a></li>
<li class="toctree-l4"><a class="reference internal" href="calc_doc.html">CALC - Position Calc</a></li>
<li class="toctree-l4"><a class="reference internal" href="clock_doc.html">CLOCK - Configurable clock</a></li>
<li class="toctree-l4"><a class="reference internal" href="counter_doc.html">COUNTER - Up/Down pulse counter</a></li>
<li class="toctree-l4"><a class="reference internal" href="div_doc.html">DIV - Pulse divider</a></li>
<li class="toctree-l4"><a class="reference internal" href="filter_doc.html">FILTER - Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="fmc_24v_doc.html">FMC_24V - FMC 24V IO Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="fmc_acq427_doc.html">FMC_ACQ427 - FMC ACQ427 Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="fmc_acq430_doc.html">FMC_ACQ430 - FMC ACQ430 Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="fmc_loopback_doc.html">FMC_LOOPBACK - FMC Loopback Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="inenc_doc.html">INENC - Input encoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="lut_doc.html">LUT - 5 Input lookup table</a></li>
<li class="toctree-l4"><a class="reference internal" href="lvdsin_doc.html">LVDSIN - LVDS Input</a></li>
<li class="toctree-l4"><a class="reference internal" href="lvdsout_doc.html">LVDSOUT - LVDS Output</a></li>
<li class="toctree-l4"><a class="reference internal" href="outenc_doc.html">OUTENC - Output encoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="pcap_doc.html">PCAP - Position Capture</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">PCOMP - Position Compare</a></li>
<li class="toctree-l4"><a class="reference internal" href="pgen_doc.html">PGEN - Position Generator</a></li>
<li class="toctree-l4"><a class="reference internal" href="posenc_doc.html">POSENC - Quadrature and step/direction encoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="pulse_doc.html">PULSE - One-shot pulse delay and stretch</a></li>
<li class="toctree-l4"><a class="reference internal" href="qdec_doc.html">QDEC - Quadrature Decoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="seq_doc.html">SEQ - Sequencer</a></li>
<li class="toctree-l4"><a class="reference internal" href="sfp_dls_eventr_doc.html">SFP_DLS_EVENTR - SFP Event Receiver Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="sfp_loopback_doc.html">SFP_LOOPBACK- SFP Loopback Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="sfp_panda_sync_doc.html">SFP_PANDA_SYNC - Synchronize data between 2 PandAs</a></li>
<li class="toctree-l4"><a class="reference internal" href="sfp_udpontrig_doc.html">SFP_UDPONTRIG - SFP UDP on trig Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="srgate_doc.html">SRGATE - Set Reset Gate</a></li>
<li class="toctree-l4"><a class="reference internal" href="system_doc.html">SYSTEM - System control FPGA</a></li>
<li class="toctree-l4"><a class="reference internal" href="ttlin_doc.html">TTLIN - TTL Input</a></li>
<li class="toctree-l4"><a class="reference internal" href="ttlout_doc.html">TTLOUT - TTL Output</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/contributing.html">Contributing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/app.html">Assembling Blocks into an App</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/block.html">Writing a Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/framework.html">Autogeneration framework architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/changelog.html">Changelog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/glossary.html">Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/testing.html">Running the tests</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial1_blinking_leds.html">Blinking LEDs Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial2_position_capture.html">Position Capture Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial3_position_compare.html">Position Compare Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/tutorial4_snake_scan.html">Snake Scan Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../blocks.html">Available Blocks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bits_doc.html">BITS - Soft inputs and constant bits</a></li>
<li class="toctree-l2"><a class="reference internal" href="calc_doc.html">CALC - Position Calc</a></li>
<li class="toctree-l2"><a class="reference internal" href="clock_doc.html">CLOCK - Configurable clock</a></li>
<li class="toctree-l2"><a class="reference internal" href="counter_doc.html">COUNTER - Up/Down pulse counter</a></li>
<li class="toctree-l2"><a class="reference internal" href="div_doc.html">DIV - Pulse divider</a></li>
<li class="toctree-l2"><a class="reference internal" href="filter_doc.html">FILTER - Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="fmc_24v_doc.html">FMC_24V - FMC 24V IO Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="fmc_acq427_doc.html">FMC_ACQ427 - FMC ACQ427 Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="fmc_acq430_doc.html">FMC_ACQ430 - FMC ACQ430 Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="fmc_loopback_doc.html">FMC_LOOPBACK - FMC Loopback Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="inenc_doc.html">INENC - Input encoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="lut_doc.html">LUT - 5 Input lookup table</a></li>
<li class="toctree-l2"><a class="reference internal" href="lvdsin_doc.html">LVDSIN - LVDS Input</a></li>
<li class="toctree-l2"><a class="reference internal" href="lvdsout_doc.html">LVDSOUT - LVDS Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="outenc_doc.html">OUTENC - Output encoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="pcap_doc.html">PCAP - Position Capture</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">PCOMP - Position Compare</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fields">Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="#position-compare-is-directional">Position compare is directional</a></li>
<li class="toctree-l3"><a class="reference internal" href="#internal-statemachine">Internal statemachine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#not-generating-a-pulse-more-than-once">Not generating a pulse more than once</a></li>
<li class="toctree-l3"><a class="reference internal" href="#guessing-the-direction">Guessing the direction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interrupting-a-scan">Interrupting a scan</a></li>
<li class="toctree-l3"><a class="reference internal" href="#position-compare-on-absolute-values">Position compare on absolute values</a></li>
<li class="toctree-l3"><a class="reference internal" href="#relative-position-compare">Relative position compare</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-as-a-schmitt-trigger">Use as a Schmitt trigger</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="pgen_doc.html">PGEN - Position Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="posenc_doc.html">POSENC - Quadrature and step/direction encoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="pulse_doc.html">PULSE - One-shot pulse delay and stretch</a></li>
<li class="toctree-l2"><a class="reference internal" href="qdec_doc.html">QDEC - Quadrature Decoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="seq_doc.html">SEQ - Sequencer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp_dls_eventr_doc.html">SFP_DLS_EVENTR - SFP Event Receiver Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp_loopback_doc.html">SFP_LOOPBACK- SFP Loopback Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp_panda_sync_doc.html">SFP_PANDA_SYNC - Synchronize data between 2 PandAs</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp_udpontrig_doc.html">SFP_UDPONTRIG - SFP UDP on trig Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="srgate_doc.html">SRGATE - Set Reset Gate</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_doc.html">SYSTEM - System control FPGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="ttlin_doc.html">TTLIN - TTL Input</a></li>
<li class="toctree-l2"><a class="reference internal" href="ttlout_doc.html">TTLOUT - TTL Output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/app.html">Assembling Blocks into an App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/block.html">Writing a Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/framework.html">Autogeneration framework architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/testing.html">Running the tests</a></li>
</ul>

            
          
  <!-- Include link to changelog -->
  <a href="https://github.com/PandABlocks/PandABlocks-FPGA/blob/master/CHANGELOG.rst">Changelog</a>
  <!-- Add versions for selected branches + tags -->
  <p class="caption"><span class="caption-text">Versions</span></p>
  <ul id="versions"/>
  <script>
    // Add any branches to appear in the side pane here, tags will be added below
    // Will only appear if docs are built and pushed in gh-pages
    var versions = ['master', 'main'];
    var dirs = new Set();
    function addVersion(name) {
      if (dirs.has(name)) {
        var li = document.createElement("li");
        var a = document.createElement("a");
        a.href = 'https://PandABlocks.github.io/PandABlocks-FPGA/' + name;
        a.innerText = name;
        li.appendChild(a)
        document.getElementById('versions').appendChild(li);
      }
    }
    Promise.all([
      // Find gh-pages directories and populate `dirs`
      fetch("https://api.github.com/repos/PandABlocks/PandABlocks-FPGA/contents?ref=gh-pages")
      .then(response => response.json())
      .then(data => data.forEach(function(e) {
        if (e.type == "dir") dirs.add(e.name);
      })),
      // Add tags to `versions`
      fetch('https://api.github.com/repos/PandABlocks/PandABlocks-FPGA/tags')
        .then(response => response.json())
        .then(data => data.forEach(function(e) {
          versions.push(e.name);
        }))
      ]).then(_ => versions.forEach(addVersion))
  </script>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PandABlocks-FPGA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../blocks.html">Available Blocks</a> &raquo;</li>
        
      <li>PCOMP - Position Compare</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/build/pcomp_doc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pcomp-position-compare">
<h1>PCOMP - Position Compare<a class="headerlink" href="#pcomp-position-compare" title="Permalink to this headline">¶</a></h1>
<p>The position compare block takes a position input and allows a regular number
of threshold comparisons to take place on a position input. The normal order
of operations is something like this:</p>
<ul class="simple">
<li>If PRE_START &gt; 0 then wait until position has passed START - PRE_START</li>
<li>If START &gt; 0 then wait until position has passed START and set OUT=1</li>
<li>Wait until position has passed START + WIDTH and set OUT=0</li>
<li>Wait until position has passed START + STEP and set OUT=1</li>
<li>Wait until position has passed START + STEP + WIDTH and set OUT=0</li>
<li>Continue until PULSES have been produced</li>
</ul>
<p>It can be used to generate a position based pulse train against an input encoder
or analogue system, or to work as repeating comparator.</p>
<div class="section" id="fields">
<h2>Fields<a class="headerlink" href="#fields" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="21%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ENABLE</td>
<td>bit_mux</td>
<td>Stop on falling edge, reset and enable on rising edge</td>
</tr>
<tr class="row-odd"><td>INP</td>
<td>pos_mux</td>
<td>Position data from position-data bus</td>
</tr>
<tr class="row-even"><td>PRE_START</td>
<td>param int</td>
<td>INP must be this far from START before waiting for START</td>
</tr>
<tr class="row-odd"><td>START</td>
<td>param int</td>
<td>Pulse absolute/relative start position value</td>
</tr>
<tr class="row-even"><td>WIDTH</td>
<td>param int</td>
<td>The relative distance between a rising and falling edge</td>
</tr>
<tr class="row-odd"><td>STEP</td>
<td>param int</td>
<td>The relative distance between successive rising edges</td>
</tr>
<tr class="row-even"><td>PULSES</td>
<td>param</td>
<td>The number of pulses to produce, 0 means infinite</td>
</tr>
<tr class="row-odd"><td>RELATIVE</td>
<td>param enum</td>
<td><div class="line-block">
<div class="line">If 1 then START is relative to the position of INP at enable</div>
<div class="line">0   Absolute</div>
<div class="line">1   Relative</div>
</div>
</td>
</tr>
<tr class="row-even"><td>DIR</td>
<td>param enum</td>
<td><div class="line-block">
<div class="line">Direction to apply all relative offsets to</div>
<div class="line">0   Positive</div>
<div class="line">1   Negative</div>
<div class="line">2   Either</div>
</div>
</td>
</tr>
<tr class="row-odd"><td>ACTIVE</td>
<td>bit_out</td>
<td>Active output is high while block is in operation</td>
</tr>
<tr class="row-even"><td>OUT</td>
<td>bit_out</td>
<td>Output pulse train</td>
</tr>
<tr class="row-odd"><td>HEALTH</td>
<td>read enum</td>
<td><div class="line-block">
<div class="line">Error details if anything goes wrong</div>
<div class="line">0   OK</div>
<div class="line">1   Position jumped by more than STEP</div>
<div class="line">2   Can’t guess DIR when RELATIVE and PRE_START=0 and START=0</div>
</div>
</td>
</tr>
<tr class="row-even"><td>PRODUCED</td>
<td>read</td>
<td>The number of pulses produced</td>
</tr>
<tr class="row-odd"><td>STATE</td>
<td>read enum</td>
<td><div class="line-block">
<div class="line">The internal statemachine state</div>
<div class="line">0   WAIT_ENABLE</div>
<div class="line">1   WAIT_DIR</div>
<div class="line">2   WAIT_PRE_START</div>
<div class="line">3   WAIT_RISING</div>
<div class="line">4   WAIT_FALLING</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="position-compare-is-directional">
<h2>Position compare is directional<a class="headerlink" href="#position-compare-is-directional" title="Permalink to this headline">¶</a></h2>
<p>A typical example would setup the parameters, enable the block, then start
moving a motor to trigger a series of pulses:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-1.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-1.png">png</a>, <a class="reference external" href="../build/pcomp_doc-1.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-1.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-1.png" class="plot-directive" src="../_images/pcomp_doc-1.png" />
</div>
<p>But if we get the direction wrong, we won’t get the first pulse until we cross
START in the correct direction:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-2.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-2.png">png</a>, <a class="reference external" href="../build/pcomp_doc-2.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-2.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-2.png" class="plot-directive" src="../_images/pcomp_doc-2.png" />
</div>
<p>Moving in a negative direction works in a similar way. Note that WIDTH and
PULSE still have positive values:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-3.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-3.png">png</a>, <a class="reference external" href="../build/pcomp_doc-3.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-3.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-3.png" class="plot-directive" src="../_images/pcomp_doc-3.png" />
</div>
</div>
<div class="section" id="internal-statemachine">
<h2>Internal statemachine<a class="headerlink" href="#internal-statemachine" title="Permalink to this headline">¶</a></h2>
<p>The Block has an internal statemachine that is exposed as a parameter, allowing
the user to see what the Block is currently doing:</p>
digraph pcomp_sm {
WAIT_ENABLE [label=&quot;State 0\nWAIT_ENABLE&quot;,]
WAIT_DIR [label=&quot;State 1\nWAIT_DIR&quot;]
WAIT_PRE_START [label=&quot;State 2\nWAIT_PRE_START&quot;]
WAIT_RISING [label=&quot;State 3\nWAIT_RISING&quot;]
WAIT_FALLING [label=&quot;State 4\nWAIT_FALLING&quot;]

WAIT_ENABLE -&gt; WAIT_DIR [label=&quot;rising ENABLE\n &amp; DIR=EITHER &quot;,fontsize=13]
WAIT_ENABLE -&gt; WAIT_PRE_START [label=&quot; rising\n ENABLE &quot;,fontsize=13]
WAIT_ENABLE -&gt; WAIT_FALLING [label=&quot;rising\nENABLE\n&amp; RELATIVE\n&amp; START=0&quot;,fontsize=13]

WAIT_DIR -&gt; WAIT_ENABLE [label=&quot; Can't guess\n DIR \n or Disabled &quot;]
[fontsize=13]
WAIT_DIR -&gt; WAIT_PRE_START [label=&quot; DIR\n calculated &quot;,fontsize=13]
WAIT_DIR -&gt; WAIT_FALLING [label=&quot; DIR calculated \n &amp; \n no PRE_START&quot;]
[fontsize=13]

WAIT_PRE_START -&gt; WAIT_ENABLE [label=&quot; Disabled &quot;][fontsize=13]
WAIT_PRE_START -&gt; WAIT_RISING [label=&quot; &lt; PRE_START &gt; &quot;][fontsize=13]

WAIT_RISING -&gt; WAIT_ENABLE [label=&quot;jump &gt;\nWIDTH + STEP\n or Disabled &quot;]
[fontsize=13]
WAIT_RISING -&gt; WAIT_FALLING [label=&quot; &gt;= pulse &quot;,fontsize=13]

WAIT_FALLING -&gt; WAIT_ENABLE
[label=&quot; jump &gt; \nWIDTH + STEP\n or Finished \nor Disabled&quot;,fontsize=13]
WAIT_FALLING -&gt; WAIT_RISING [label=&quot; &gt;= pulse \n + WIDTH &quot;]
[fontsize=13]
}
</div>
<div class="section" id="not-generating-a-pulse-more-than-once">
<h2>Not generating a pulse more than once<a class="headerlink" href="#not-generating-a-pulse-more-than-once" title="Permalink to this headline">¶</a></h2>
<p>A key part of position compare is not generating a pulse at a position more
than once. This is to deal with noisy encoders:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-4.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-4.png">png</a>, <a class="reference external" href="../build/pcomp_doc-4.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-4.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-4.png" class="plot-directive" src="../_images/pcomp_doc-4.png" />
</div>
<p>This means that care is needed if using direction sensing or relying on the
directionality of the encoder when passing the start position. For example,
if we approach START from the negative direction while doing a positive
position compare, then jitter back over the start position, we will generate
start at the wrong place. If you look carefully at the statemachine you will
see that the Block crossed into WAIT_START when INP &lt; 4 (START), which is too
soon for this amount of jitter:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-5.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-5.png">png</a>, <a class="reference external" href="../build/pcomp_doc-5.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-5.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-5.png" class="plot-directive" src="../_images/pcomp_doc-5.png" />
</div>
<p>We can fix this by adding to the PRE_START deadband which the encoder has to
cross in order to advance to the WAIT_START state. Now INP &lt; 2 (START-PRE_START)
is used for the condition of crossing into WAIT_START:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-6.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-6.png">png</a>, <a class="reference external" href="../build/pcomp_doc-6.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-6.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-6.png" class="plot-directive" src="../_images/pcomp_doc-6.png" />
</div>
</div>
<div class="section" id="guessing-the-direction">
<h2>Guessing the direction<a class="headerlink" href="#guessing-the-direction" title="Permalink to this headline">¶</a></h2>
<p>We can also ask to the Block to calculate direction for us:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-7.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-7.png">png</a>, <a class="reference external" href="../build/pcomp_doc-7.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-7.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-7.png" class="plot-directive" src="../_images/pcomp_doc-7.png" />
</div>
<p>This is a one time calculation of direction at the start of operation, once
the encoder has been moved enough to guess the direction then it is fixed until
the Block has finished producing pulses:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-8.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-8.png">png</a>, <a class="reference external" href="../build/pcomp_doc-8.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-8.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-8.png" class="plot-directive" src="../_images/pcomp_doc-8.png" />
</div>
</div>
<div class="section" id="interrupting-a-scan">
<h2>Interrupting a scan<a class="headerlink" href="#interrupting-a-scan" title="Permalink to this headline">¶</a></h2>
<p>When the ENABLE input is set low the output will cease. This will happen even if
the ENABLE is set low when there are still cycles of the output pulse to
generate, or if the ENABLE = 0 is set at the same time as a position match.</p>
<p>(<a class="reference external" href="../build/pcomp_doc-9.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-9.png">png</a>, <a class="reference external" href="../build/pcomp_doc-9.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-9.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-9.png" class="plot-directive" src="../_images/pcomp_doc-9.png" />
</div>
<p>(<a class="reference external" href="../build/pcomp_doc-10.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-10.png">png</a>, <a class="reference external" href="../build/pcomp_doc-10.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-10.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-10.png" class="plot-directive" src="../_images/pcomp_doc-10.png" />
</div>
</div>
<div class="section" id="position-compare-on-absolute-values">
<h2>Position compare on absolute values<a class="headerlink" href="#position-compare-on-absolute-values" title="Permalink to this headline">¶</a></h2>
<p>Doing position compare on an absolute value adds additional challenges, as
we are not guaranteed to see every transition. It works in much the same
way as the previous examples, but we trigger on greater than or equal rather
than just greater than:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-11.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-11.png">png</a>, <a class="reference external" href="../build/pcomp_doc-11.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-11.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-111.png" class="plot-directive" src="../_images/pcomp_doc-111.png" />
</div>
<p>But what should the Block do if the output is 0 and the position jumps by
enough to trigger a transition to 1 and then back to 0? We handle this by
setting HEALTH=”Error: Position jumped by more than STEP” and aborting
the compare:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-12.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-12.png">png</a>, <a class="reference external" href="../build/pcomp_doc-12.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-12.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-12.png" class="plot-directive" src="../_images/pcomp_doc-12.png" />
</div>
<p>Likewise if the output is 1 and the position causes us to need to produce a 0
then 1:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-13.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-13.png">png</a>, <a class="reference external" href="../build/pcomp_doc-13.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-13.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-13.png" class="plot-directive" src="../_images/pcomp_doc-13.png" />
</div>
<p>And if we skipped a larger number of points we get the same error:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-14.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-14.png">png</a>, <a class="reference external" href="../build/pcomp_doc-14.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-14.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-14.png" class="plot-directive" src="../_images/pcomp_doc-14.png" />
</div>
</div>
<div class="section" id="relative-position-compare">
<h2>Relative position compare<a class="headerlink" href="#relative-position-compare" title="Permalink to this headline">¶</a></h2>
<p>We may want to nest position compare blocks, or respond to some external event.
In which case, we expose the option to a position compare relative to the
latched position at the start:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-15.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-15.png">png</a>, <a class="reference external" href="../build/pcomp_doc-15.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-15.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-15.png" class="plot-directive" src="../_images/pcomp_doc-15.png" />
</div>
<p>If we want it to start immediately on ENABLE then we set START and PRE_START=0:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-16.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-16.png">png</a>, <a class="reference external" href="../build/pcomp_doc-16.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-16.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-16.png" class="plot-directive" src="../_images/pcomp_doc-16.png" />
</div>
<p>We can also guess the direction in relative mode:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-17.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-17.png">png</a>, <a class="reference external" href="../build/pcomp_doc-17.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-17.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-17.png" class="plot-directive" src="../_images/pcomp_doc-17.png" />
</div>
<p>This works when going negative too:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-18.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-18.png">png</a>, <a class="reference external" href="../build/pcomp_doc-18.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-18.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-18.png" class="plot-directive" src="../_images/pcomp_doc-18.png" />
</div>
<p>And with a PRE_START value we guess the direction to be the opposite to the
direction the motor is travelling when it exceeds PRE_START:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-19.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-19.png">png</a>, <a class="reference external" href="../build/pcomp_doc-19.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-19.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-19.png" class="plot-directive" src="../_images/pcomp_doc-19.png" />
</div>
<p>We cannot guess the direction when RELATIVE mode is set with no START or
PRE_START though, the Block will error in this case:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-20.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-20.png">png</a>, <a class="reference external" href="../build/pcomp_doc-20.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-20.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-20.png" class="plot-directive" src="../_images/pcomp_doc-20.png" />
</div>
</div>
<div class="section" id="use-as-a-schmitt-trigger">
<h2>Use as a Schmitt trigger<a class="headerlink" href="#use-as-a-schmitt-trigger" title="Permalink to this headline">¶</a></h2>
<p>We can also make use of a special case with STEP=0 and a negative WIDTH to
create a Schmitt trigger that will always trigger at START, and turn off when
INP has dipped WIDTH below START:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-21.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-21.png">png</a>, <a class="reference external" href="../build/pcomp_doc-21.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-21.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-211.png" class="plot-directive" src="../_images/pcomp_doc-211.png" />
</div>
<p>We can use this same special case with a positive width to make a similar
comparator that turns on at START and off at START+WIDTH, triggering again
when INP &lt;= START:</p>
<p>(<a class="reference external" href="../build/pcomp_doc-22.py">Source code</a>, <a class="reference external" href="../build/pcomp_doc-22.png">png</a>, <a class="reference external" href="../build/pcomp_doc-22.hires.png">hires.png</a>, <a class="reference external" href="../build/pcomp_doc-22.pdf">pdf</a>)</p>
<div class="figure">
<img alt="../_images/pcomp_doc-22.png" class="plot-directive" src="../_images/pcomp_doc-22.png" />
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="pgen_doc.html" class="btn btn-neutral float-right" title="PGEN - Position Generator" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pcap_doc.html" class="btn btn-neutral float-left" title="PCAP - Position Capture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Diamond Light Source

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>